# Ultralytics üöÄ Custom Detection Trainer (bit depth + keep original size)

from copy import copy
from ultralytics.models.yolo.detect.train import DetectionTrainer
from ultralytics.utils.torch_utils import unwrap_model
from ultralytics.utils import LOGGER
from ultralytics import yolo

# –µ—Å–ª–∏ —Ç–≤–æ–π –∫–∞—Å—Ç–æ–º–Ω—ã–π BaseDataset –≤ ultralytics/data/dataset.py
from ultralytics.data.dataset import BaseDataset


class CustomDetectionTrainer(DetectionTrainer):
    """Detection trainer —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π 16-–±–∏—Ç–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞."""

    def build_dataset(self, img_path, mode="train", batch=None):
        """–°–æ–∑–¥–∞–µ—Ç –¥–∞—Ç–∞—Å–µ—Ç —Å —É—á—ë—Ç–æ–º bit_depth –∏ keep_original_size."""
        gs = max(int(unwrap_model(self.model).stride.max() if self.model else 0), 32)

        dataset = BaseDataset(
            img_path=img_path,
            imgsz=self.args.imgsz,
            augment=mode == "train",
            hyp=self.args,
            rect=mode == "val",
            cache=self.args.cache,
            prefix=mode,
            bit_depth=getattr(self.args, "bit_depth", 8),
            keep_original_size=getattr(self.args, "keep_original_size", False),
        )
        LOGGER.info(f"Loaded dataset ({mode}) with {len(dataset)} images "
                    f"(bit_depth={getattr(self.args, 'bit_depth', 8)}, "
                    f"keep_original_size={getattr(self.args, 'keep_original_size', False)})")
        return dataset

    def preprocess_batch(self, batch):
        """–ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å —É—á–µ—Ç–æ–º –±–∏—Ç–Ω–æ—Å—Ç–∏."""
        batch["img"] = batch["img"].to(self.device, non_blocking=True).float()

        bit_depth = getattr(self.args, "bit_depth", 8)
        normalization_value = 65535.0 if bit_depth == 16 else 255.0

        batch["img"] /= normalization_value
        return batch
